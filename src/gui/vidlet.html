<!DOCTYPE html>
<html data-vidlet data-width="480" data-height="400">
<head>
  <meta charset="UTF-8">
  <title>VidLet</title>
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{--bg:#09090b;--bg2:#18181b;--bg3:#27272a;--brd:#3f3f46;--txt:#fafafa;--txt2:#a1a1aa;--txt3:#71717a;--acc:#a855f7;--acc2:#c084fc}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--txt);font:12px/1.4 system-ui,-apple-system,sans-serif}
    .app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

    /* Header - PicLet style */
    .hd{display:flex;flex-direction:column;padding:10px 12px 8px;border-bottom:1px solid var(--brd)}
    .hd-top{display:flex;align-items:center;gap:10px;width:100%}
    .hd-brand{display:flex;flex-direction:column;gap:1px}
    .hd-title{display:flex;align-items:baseline;gap:8px}
    .hd-title b{font-size:18px;color:var(--acc);letter-spacing:-0.5px;font-weight:700}
    .hd-subtitle{font-size:9px;color:var(--acc2);font-weight:600;text-transform:uppercase;letter-spacing:1.5px;opacity:0.9}
    .hd-desc{font-size:10px;color:var(--txt3);margin-top:1px}
    .hd-links{margin-left:auto;display:flex;gap:6px;align-items:center}
    .hd-link{font-size:9px;color:var(--acc);text-decoration:none;padding:5px 10px;background:rgba(168,85,247,0.1);border:1px solid rgba(168,85,247,0.3);border-radius:4px;transition:all .2s;font-weight:500}
    .hd-link:hover{color:#000;border-color:var(--acc);background:var(--acc)}
    .hd-coffee{display:flex;align-items:center;gap:4px;font-size:9px;color:#ffdd00;text-decoration:none;padding:5px 8px;background:rgba(255,221,0,0.1);border:1px solid rgba(255,221,0,0.25);border-radius:4px;transition:all .2s;font-weight:500}
    .hd-coffee:hover{color:#000;border-color:#ffdd00;background:#ffdd00}
    .hd-coffee svg{width:12px;height:12px;fill:currentColor}
    .hd-meta{display:flex;align-items:center;gap:12px;font-size:10px;color:var(--txt3);margin-top:6px;padding-top:6px;border-top:1px solid var(--brd)}
    .hd-meta b{color:var(--txt2);font-weight:500;margin-left:3px}

    /* Main */
    .main{display:flex;flex:1;overflow:hidden}

    /* Sidebar */
    .side{width:160px;border-right:1px solid var(--brd);display:flex;flex-direction:column;background:var(--bg)}
    .tools{flex:1;overflow-y:auto;padding:6px}
    .tool{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;cursor:pointer;transition:all .12s;margin-bottom:2px}
    .tool:hover{background:var(--bg2)}
    .tool.active{background:var(--acc);color:#fff}
    .tool.active svg{stroke:#fff}
    .tool.disabled{opacity:0.3;pointer-events:none}
    .tool svg{width:16px;height:16px;flex-shrink:0}
    .tool span{font-size:11px;font-weight:500}

    /* Content */
    .content{flex:1;display:flex;flex-direction:column;overflow:hidden}

    /* Preview */
    .preview{flex:1;background:var(--bg2);display:flex;align-items:center;justify-content:center;overflow:hidden;min-height:0}
    .preview video{max-width:100%;max-height:100%;object-fit:contain}

    /* Options panel */
    .opts{background:var(--bg);border-top:1px solid var(--brd);padding:10px 12px;display:none}
    .opts.active{display:block}
    .opts-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .opts-row:last-child{margin-bottom:0}
    .opts-row label{font-size:10px;color:var(--txt3);width:60px;flex-shrink:0}
    .opts-row input,.opts-row select{flex:1;background:var(--bg2);border:1px solid var(--brd);border-radius:4px;padding:5px 8px;color:var(--txt);font-size:11px}
    .opts-row input:focus,.opts-row select:focus{outline:none;border-color:var(--acc)}
    .opts-row span{font-size:10px;color:var(--txt3);width:30px}
    .opts-row .check{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--txt2);cursor:pointer}
    .opts-row .check input{width:auto;flex:none}

    /* Timeline control */
    .timeline{flex:1;height:24px;position:relative;user-select:none}
    .timeline-track{position:absolute;inset:0;background:var(--bg2);border-radius:4px;border:1px solid var(--brd);overflow:hidden}
    .timeline-range{position:absolute;top:0;bottom:0;background:linear-gradient(90deg,var(--acc),var(--acc2));opacity:0.4}
    .timeline-handle{position:absolute;top:-2px;bottom:-2px;width:8px;background:var(--acc);border-radius:2px;cursor:ew-resize;transition:background .15s}
    .timeline-handle:hover,.timeline-handle.dragging{background:var(--acc2)}
    .timeline-handle::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:2px;height:10px;background:rgba(0,0,0,0.3);border-radius:1px}
    .timeline-start{left:0}
    .timeline-end{right:0}

    /* Footer */
    .ft{display:flex;gap:6px;padding:10px 12px;border-top:1px solid var(--brd);justify-content:flex-end}
    .btn{padding:6px 14px;border-radius:5px;font-size:11px;font-weight:500;cursor:pointer;border:none;transition:all .12s}
    .btn-g{background:var(--bg2);color:var(--txt2)}
    .btn-g:hover{background:var(--bg3)}
    .btn-p{background:var(--acc);color:#fff}
    .btn-p:hover{background:#9333ea}
    .btn-p:disabled{opacity:0.4;cursor:not-allowed}

    /* States */
    .ld,.dn{position:fixed;inset:0;background:var(--bg);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:50}
    .ld.on,.dn.on{display:flex}
    .sp{width:24px;height:24px;border:2px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ld span{margin-top:10px;color:var(--txt2);font-size:11px}
    .dn h4{font-size:14px;margin-bottom:4px}
    .dn p{font-size:11px;color:var(--txt2);max-width:300px;word-break:break-all}
    .dn.ok h4{color:#22c55e}
    .dn.err h4{color:#ef4444}
    .hide{display:none!important}
    .hidden{display:none!important}
    .tool.done{opacity:0.4;pointer-events:none}
    .tool.done span::after{content:' ✓';color:#22c55e}

    /* Mode/Position buttons */
    .mode-btn,.pos-btn{flex:1;padding:6px 8px;border:1px solid var(--brd);border-radius:4px;background:var(--bg2);color:var(--txt2);font-size:10px;cursor:pointer;transition:all .15s}
    .mode-btn:hover,.pos-btn:hover{border-color:var(--acc);color:var(--txt)}
    .mode-btn.active,.pos-btn.active{background:var(--acc);border-color:var(--acc);color:#fff}

    /* Toggle switch */
    .toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
    .toggle-track{width:32px;height:18px;background:var(--bg3);border-radius:9px;position:relative;transition:background .2s}
    .toggle-track::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:var(--txt3);border-radius:50%;transition:all .2s}
    .toggle.on .toggle-track{background:var(--acc)}
    .toggle.on .toggle-track::after{left:16px;background:#fff}
    .toggle-label{font-size:10px;color:var(--txt2)}

    /* Crop overlay for shorts */
    .preview-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden;min-height:0}
    .crop-overlay{position:absolute;inset:0;pointer-events:none;display:none}
    .crop-overlay.active{display:block;pointer-events:auto}
    .crop-mask{position:absolute;inset:0;background:rgba(0,0,0,0.6)}
    .crop-window{position:absolute;top:0;bottom:0;background:transparent;border:2px solid var(--acc);box-shadow:0 0 0 9999px rgba(0,0,0,0.6);cursor:ew-resize}
    .crop-window::before{content:'9:16';position:absolute;top:8px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--acc);background:rgba(0,0,0,0.7);padding:2px 6px;border-radius:3px}
    .crop-handle{position:absolute;top:50%;width:20px;height:40px;background:var(--acc);border-radius:4px;transform:translateY(-50%);cursor:ew-resize}
    .crop-handle-l{left:-10px}
    .crop-handle-r{right:-10px}
  </style>
</head>
<body>
  <div class="app">
    <div class="hd">
      <div class="hd-top">
        <div class="hd-brand">
          <div class="hd-title">
            <b>VidLet</b>
            <span class="hd-subtitle">Compress. Convert. Create.</span>
          </div>
          <span class="hd-desc">Lightweight video tools for content creators</span>
        </div>
        <div class="hd-links">
          <a href="#" class="hd-coffee" onclick="VidLet.openUrl('https://buymeacoffee.com/spark88');return false">
            <svg viewBox="0 0 24 24"><path d="M20.216 6.415l-.132-.666c-.119-.598-.388-1.163-1.001-1.379-.197-.069-.42-.098-.57-.241-.152-.143-.196-.366-.231-.572-.065-.378-.125-.756-.192-1.133-.057-.325-.102-.69-.25-.987-.195-.4-.597-.634-.996-.788a5.723 5.723 0 00-.626-.194c-1-.263-2.05-.36-3.077-.416a25.834 25.834 0 00-3.7.062c-.915.083-1.88.184-2.75.5-.318.116-.646.256-.888.501-.297.302-.393.77-.177 1.146.154.267.415.456.692.58.36.162.737.284 1.123.366 1.075.238 2.189.331 3.287.37 1.218.05 2.437.01 3.65-.118.299-.033.598-.073.896-.119.352-.054.578-.513.474-.834-.124-.383-.457-.531-.834-.473-.466.074-.96.108-1.382.146-1.177.08-2.358.082-3.536.006a22.228 22.228 0 01-1.157-.107c-.086-.01-.18-.025-.258-.036-.243-.036-.484-.08-.724-.13-.111-.027-.111-.185 0-.212h.005c.277-.06.557-.108.838-.147h.002c.131-.009.263-.032.394-.048a25.076 25.076 0 013.426-.12c.674.019 1.347.067 2.017.144l.228.031c.267.04.533.088.798.145.392.085.895.113 1.07.542.055.137.08.288.111.431l.319 1.484a.237.237 0 01-.199.284h-.003c-.037.006-.075.01-.112.015a36.704 36.704 0 01-4.743.295 37.059 37.059 0 01-4.699-.304c-.14-.017-.293-.042-.417-.06-.326-.048-.649-.108-.973-.161-.393-.065-.768-.032-1.123.161-.29.16-.527.404-.675.701-.154.316-.199.66-.267 1-.069.34-.176.707-.135 1.056.087.753.613 1.365 1.37 1.502a39.69 39.69 0 0011.343.376.483.483 0 01.535.53l-.071.697-1.018 9.907c-.041.41-.047.832-.125 1.237-.122.637-.553 1.028-1.182 1.171-.577.131-1.165.2-1.756.205-.656.004-1.31-.025-1.966-.022-.699.004-1.556-.06-2.095-.58-.475-.458-.54-1.174-.605-1.793l-.731-7.013-.322-3.094c-.037-.351-.286-.695-.678-.678-.336.015-.718.3-.678.679l.228 2.185.949 9.112c.147 1.344 1.174 2.068 2.446 2.272.742.12 1.503.144 2.257.156.966.016 1.942.053 2.892-.122 1.408-.258 2.465-1.198 2.616-2.657.34-3.332.683-6.663 1.024-9.995l.215-2.087a.484.484 0 01.39-.426c.402-.078.787-.212 1.074-.518.455-.488.546-1.124.385-1.766zm-1.478.772c-.145.137-.363.201-.578.233-2.416.359-4.866.54-7.308.46-1.748-.06-3.477-.254-5.207-.498-.17-.024-.353-.055-.47-.18-.22-.236-.111-.71-.054-.995.052-.26.152-.609.463-.646.484-.057 1.046.148 1.526.22.577.088 1.156.159 1.737.212 2.48.226 5.002.19 7.472-.14.45-.06.899-.13 1.345-.21.399-.072.84-.206 1.08.206.166.281.188.657.162.974a.544.544 0 01-.169.364z"/></svg>
            Donate
          </a>
          <a href="#" id="homepageLink" class="hd-link" onclick="openHomepage();return false">vidlet.app</a>
        </div>
      </div>
      <div class="hd-meta">
        <div>File<b id="fileName">-</b></div>
        <div>Size<b id="size">-</b></div>
        <div>Duration<b id="duration">-</b></div>
        <div>FPS<b id="fps">-</b></div>
      </div>
    </div>

    <div class="main" id="main">
      <div class="side">
        <div class="tools">
          <!-- MKV → MP4 first (only shown for MKV files) -->
          <div class="tool hidden" id="t-mkv2mp4" onclick="selectTool('mkv2mp4')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/></svg>
            <span>MKV → MP4</span>
          </div>
          <!-- Then editing tools -->
          <div class="tool" id="t-trim" onclick="selectTool('trim')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" y1="4" x2="8.12" y2="15.88"/><line x1="14.47" y1="14.48" x2="20" y2="20"/><line x1="8.12" y1="8.12" x2="12" y2="12"/></svg>
            <span>Trim</span>
          </div>
          <div class="tool" id="t-compress" onclick="selectTool('compress')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18m-6-6 6 6 6-6M6 9l6-6 6 6"/></svg>
            <span>Compress</span>
          </div>
          <div class="tool" id="t-shrink" onclick="selectTool('shrink')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>
            <span>Shrink</span>
          </div>
          <div class="tool" id="t-loop" onclick="selectTool('loop')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>
            <span>Loop</span>
          </div>
          <!-- Export tools -->
          <div class="tool hidden" id="t-shorts" onclick="selectTool('shorts')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="7" y="2" width="10" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18.01"/></svg>
            <span>Make Shorts</span>
          </div>
          <div class="tool" id="t-togif" onclick="selectTool('togif')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
            <span>To GIF</span>
          </div>
          <div class="tool" id="t-thumb" onclick="selectTool('thumb')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
            <span>Thumbnail</span>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="preview-wrap" id="previewWrap">
          <video id="videoPreview" controls muted loop></video>
          <div class="crop-overlay" id="cropOverlay">
            <div class="crop-window" id="cropWindow">
              <div class="crop-handle crop-handle-l"></div>
              <div class="crop-handle crop-handle-r"></div>
            </div>
          </div>
        </div>

        <!-- Options panels -->
        <div class="opts" id="opts-compress">
          <div class="opts-row"><label>Bitrate</label><input type="number" id="compress-bitrate" value="2500" min="500" max="10000" step="100"><span>kb/s</span></div>
          <div class="opts-row"><label>Speed</label><select id="compress-preset"><option value="ultrafast">Fastest</option><option value="veryfast">Faster</option><option value="fast">Fast</option><option value="medium" selected>Balanced</option><option value="slow">Quality</option><option value="veryslow">Best</option></select></div>
        </div>
        <div class="opts" id="opts-togif">
          <div class="opts-row"><label>FPS</label><input type="number" id="togif-fps" value="15" min="5" max="30"></div>
          <div class="opts-row"><label>Width</label><input type="number" id="togif-width" value="480" min="0" max="1920" step="10"><span>px</span></div>
          <div class="opts-row"><label>Dither</label><select id="togif-dither"><option value="floyd_steinberg" selected>Smooth</option><option value="sierra2">Sharp</option><option value="bayer">Retro</option><option value="none">None</option></select></div>
        </div>
        <div class="opts" id="opts-mkv2mp4">
          <div class="opts-row"><label>Mode</label><div class="toggle on" id="mkv2mp4-toggle" onclick="toggleMkv()"><div class="toggle-track"></div><span class="toggle-label">Fast copy</span></div></div>
          <div class="opts-row mkv-quality" style="display:none"><label>Quality</label><select id="mkv2mp4-quality"><option value="18">High</option><option value="23" selected>Balanced</option><option value="28">Smaller</option></select></div>
        </div>
        <div class="opts" id="opts-shrink">
          <div class="opts-row"><label>Target</label><input type="number" id="shrink-duration" value="59.5" min="1" max="300" step="0.5"><span>sec</span></div>
        </div>
        <div class="opts" id="opts-loop">
          <div class="opts-row"><label>Detect</label><div class="toggle on" id="loop-toggle" onclick="toggleLoopAuto()"><div class="toggle-track"></div><span class="toggle-label">Auto-find loop</span></div></div>
          <div class="opts-row loop-manual" style="display:none"><label>Start</label><input type="number" id="loop-start" value="0" min="0" step="0.1"><span>sec</span></div>
          <div class="opts-row loop-manual" style="display:none"><label>End</label><input type="number" id="loop-end" value="5" min="0" step="0.1"><span>sec</span></div>
        </div>
        <div class="opts" id="opts-thumb">
          <div class="opts-row"><label>Image</label><input type="text" id="thumb-image" placeholder="Drop or paste image path..."></div>
        </div>
        <div class="opts" id="opts-shorts">
          <div class="opts-row"><label>Style</label>
            <div style="display:flex;gap:6px;flex:1">
              <button type="button" class="mode-btn active" id="shorts-crop" onclick="setShortsMode('crop')">Crop</button>
              <button type="button" class="mode-btn" id="shorts-blur" onclick="setShortsMode('blur')">Blur BG</button>
            </div>
          </div>
          <div class="opts-row shorts-hint"><label></label><span style="font-size:9px;color:var(--txt3)">Drag the overlay on video to select crop area</span></div>
        </div>
        <div class="opts" id="opts-trim">
          <div class="opts-row" style="margin-bottom:10px">
            <div class="timeline" id="timeline">
              <div class="timeline-track">
                <div class="timeline-range" id="timeline-range"></div>
                <div class="timeline-handle timeline-start" id="handle-start"></div>
                <div class="timeline-handle timeline-end" id="handle-end"></div>
              </div>
            </div>
          </div>
          <div class="opts-row">
            <label>Start</label>
            <input type="number" id="trim-start" value="0" min="0" step="0.1" onchange="updateTimeline()">
            <span>sec</span>
            <label style="width:auto;margin-left:8px">End</label>
            <input type="number" id="trim-end" value="10" min="0" step="0.1" onchange="updateTimeline()">
            <span>sec</span>
          </div>
          <div class="opts-row">
            <label>Precise</label>
            <div class="toggle" id="trim-toggle" onclick="toggleTrimAccurate()"><div class="toggle-track"></div><span class="toggle-label">Re-encode</span></div>
            <span id="trim-output" style="width:auto;margin-left:auto;color:var(--acc);font-size:11px"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="ft" id="btns">
      <button class="btn btn-g" onclick="VidLet.cancel()">Cancel</button>
      <button class="btn btn-p" id="processBtn" onclick="process()" disabled>Process</button>
    </div>

    <div class="ld" id="loading"><div class="sp"></div><span>Processing...</span></div>
    <div class="dn" id="done">
      <h4>Done!</h4>
      <p id="output"></p>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-g" onclick="continueEditing()">Continue</button>
        <button class="btn btn-p" onclick="VidLet.close()">Done</button>
      </div>
    </div>
  </div>

  <script src="/js/vidlet.js"></script>
  <script>
    const { $, log, postJson, formatDuration } = VidLet;
    let info = {}, activeTool = null, homepage = 'https://vidlet.app';
    let currentFilePath = null; // Track the current working file (may change after MKV→MP4)

    function openHomepage() {
      VidLet.openUrl(homepage);
    }

    async function init() {
      const res = await VidLet.fetchJson('/api/info');
      info = res;
      currentFilePath = res.filePath; // Start with the original file
      updateFileDisplay();
      $('videoPreview').src = '/api/video';

      // Resize window to match video aspect ratio
      if (res.width && res.height) {
        VidLet.resizeToVideo(res.width, res.height);
      }

      if (res.defaults) {
        if (res.defaults.compress) { $('compress-bitrate').value = res.defaults.compress.bitrate || 2500; $('compress-preset').value = res.defaults.compress.preset || 'medium'; }
        if (res.defaults.togif) { $('togif-fps').value = res.defaults.togif.fps || 15; $('togif-width').value = res.defaults.togif.width || 480; }
        if (res.defaults.shrink) { $('shrink-duration').value = res.defaults.shrink.targetDuration || 59.5; }
        if (res.defaults.homepage) {
          homepage = res.defaults.homepage;
          const domain = homepage.replace(/^https?:\/\//, '').replace(/\/$/, '');
          $('homepageLink').textContent = domain;
        }
      }

      // Show MKV→MP4 only for MKV files
      if (res.defaults?.isMkv) {
        $('t-mkv2mp4').classList.remove('hidden');
      }

      // Show Make Shorts only for landscape (16:9) videos
      if (res.defaults?.isLandscape) {
        $('t-shorts').classList.remove('hidden');
      }

      $('loop-end').max = res.duration; $('loop-start').max = res.duration; $('loop-end').value = Math.min(5, res.duration);

      // Initialize trim controls
      $('trim-start').max = res.duration;
      $('trim-end').max = res.duration;
      $('trim-end').value = res.duration;
      updateTimeline();
      initTimelineHandles();
      initCropOverlay();
    }

    function updateFileDisplay() {
      $('fileName').textContent = ' ' + info.fileName;
      $('size').textContent = ' ' + `${info.width}×${info.height}`;
      $('duration').textContent = ' ' + formatDuration(info.duration);
      $('fps').textContent = ' ' + (info.fps ? info.fps.toFixed(1) : '-');
    }

    function selectTool(id) {
      document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.opts').forEach(o => o.classList.remove('active'));
      const el = $('t-' + id), opts = $('opts-' + id);
      if (el && !el.classList.contains('disabled') && !el.classList.contains('done')) {
        el.classList.add('active');
        if (opts) opts.classList.add('active');
        activeTool = id;
        $('processBtn').disabled = false;
        // Show crop overlay for shorts in crop mode
        $('cropOverlay').classList.toggle('active', id === 'shorts' && shortsMode === 'crop');
        if (id === 'shorts') updateCropOverlay();
      } else {
        activeTool = null;
        $('processBtn').disabled = true;
        $('cropOverlay').classList.remove('active');
      }
    }

    // Toggle states
    let mkvFastCopy = true;
    let loopAutoDetect = true;
    let trimAccurate = false;
    let shortsMode = 'crop';
    let shortsCropX = 0.5; // 0-1, where 0.5 is center

    function toggleMkv() {
      mkvFastCopy = !mkvFastCopy;
      $('mkv2mp4-toggle').classList.toggle('on', mkvFastCopy);
      $('mkv2mp4-toggle').querySelector('.toggle-label').textContent = mkvFastCopy ? 'Fast copy' : 'Re-encode';
      document.querySelectorAll('.mkv-quality').forEach(el => el.style.display = mkvFastCopy ? 'none' : 'flex');
    }

    function toggleLoopAuto() {
      loopAutoDetect = !loopAutoDetect;
      $('loop-toggle').classList.toggle('on', loopAutoDetect);
      $('loop-toggle').querySelector('.toggle-label').textContent = loopAutoDetect ? 'Auto-find loop' : 'Manual';
      document.querySelectorAll('.loop-manual').forEach(el => el.style.display = loopAutoDetect ? 'none' : 'flex');
    }

    function toggleTrimAccurate() {
      trimAccurate = !trimAccurate;
      $('trim-toggle').classList.toggle('on', trimAccurate);
    }

    function setShortsMode(mode) {
      shortsMode = mode;
      $('shorts-crop').classList.toggle('active', mode === 'crop');
      $('shorts-blur').classList.toggle('active', mode === 'blur');
      // Show/hide crop overlay
      $('cropOverlay').classList.toggle('active', mode === 'crop' && activeTool === 'shorts');
      document.querySelector('.shorts-hint').style.display = mode === 'crop' ? 'flex' : 'none';
      if (mode === 'crop') updateCropOverlay();
    }

    // Crop overlay for shorts
    function updateCropOverlay() {
      const video = $('videoPreview');
      const overlay = $('cropOverlay');
      const cropWindow = $('cropWindow');
      if (!video.videoWidth || !info.width) return;

      // Get video display size
      const videoRect = video.getBoundingClientRect();
      const wrapRect = $('previewWrap').getBoundingClientRect();

      // Calculate 9:16 window size relative to video
      const targetAspect = 9 / 16;
      const videoAspect = info.width / info.height;
      const cropWidthRatio = targetAspect / videoAspect;

      // Position overlay to match video
      const vLeft = videoRect.left - wrapRect.left;
      const vTop = videoRect.top - wrapRect.top;
      overlay.style.left = vLeft + 'px';
      overlay.style.top = vTop + 'px';
      overlay.style.width = videoRect.width + 'px';
      overlay.style.height = videoRect.height + 'px';

      // Size crop window
      const cropW = videoRect.width * cropWidthRatio;
      const maxX = videoRect.width - cropW;
      const cropX = shortsCropX * maxX;

      cropWindow.style.width = cropW + 'px';
      cropWindow.style.left = cropX + 'px';
    }

    function initCropOverlay() {
      const cropWindow = $('cropWindow');
      let dragging = false;
      let startX = 0;
      let startLeft = 0;

      cropWindow.addEventListener('mousedown', (e) => {
        e.preventDefault();
        dragging = true;
        startX = e.clientX;
        startLeft = cropWindow.offsetLeft;
        document.addEventListener('mousemove', onDrag);
        document.addEventListener('mouseup', onDragEnd);
      });

      function onDrag(e) {
        if (!dragging) return;
        const overlay = $('cropOverlay');
        const cropW = cropWindow.offsetWidth;
        const maxX = overlay.offsetWidth - cropW;
        let newLeft = startLeft + (e.clientX - startX);
        newLeft = Math.max(0, Math.min(maxX, newLeft));
        cropWindow.style.left = newLeft + 'px';
        shortsCropX = maxX > 0 ? newLeft / maxX : 0.5;
      }

      function onDragEnd() {
        dragging = false;
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', onDragEnd);
      }

      // Update on video load and resize
      $('videoPreview').addEventListener('loadedmetadata', updateCropOverlay);
      window.addEventListener('resize', updateCropOverlay);
    }

    // Timeline control for trim
    function updateTimeline() {
      const duration = info.duration || 10;
      const start = parseFloat($('trim-start').value) || 0;
      const end = parseFloat($('trim-end').value) || duration;
      const startPct = (start / duration) * 100;
      const endPct = (end / duration) * 100;

      $('timeline-range').style.left = startPct + '%';
      $('timeline-range').style.width = (endPct - startPct) + '%';
      $('handle-start').style.left = 'calc(' + startPct + '% - 4px)';
      $('handle-end').style.left = 'calc(' + endPct + '% - 4px)';

      const outputDuration = Math.max(0, end - start);
      $('trim-output').textContent = outputDuration.toFixed(1) + 's';
    }

    function initTimelineHandles() {
      const timeline = $('timeline');
      const handleStart = $('handle-start');
      const handleEnd = $('handle-end');
      let dragging = null;

      function onMouseMove(e) {
        if (!dragging) return;
        const rect = timeline.getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        const time = pct * info.duration;

        if (dragging === 'start') {
          const endVal = parseFloat($('trim-end').value);
          $('trim-start').value = Math.min(time, endVal - 0.1).toFixed(1);
        } else {
          const startVal = parseFloat($('trim-start').value);
          $('trim-end').value = Math.max(time, startVal + 0.1).toFixed(1);
        }
        updateTimeline();
      }

      function onMouseUp() {
        if (dragging) {
          (dragging === 'start' ? handleStart : handleEnd).classList.remove('dragging');
          dragging = null;
        }
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }

      handleStart.addEventListener('mousedown', (e) => {
        e.preventDefault();
        dragging = 'start';
        handleStart.classList.add('dragging');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });

      handleEnd.addEventListener('mousedown', (e) => {
        e.preventDefault();
        dragging = 'end';
        handleEnd.classList.add('dragging');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    }

    function getOpts() {
      const o = { tool: activeTool, inputPath: currentFilePath };
      if (activeTool === 'compress') { o.bitrate = +$('compress-bitrate').value; o.preset = $('compress-preset').value; }
      if (activeTool === 'togif') { o.fps = +$('togif-fps').value; o.width = +$('togif-width').value; o.dither = $('togif-dither').value; }
      if (activeTool === 'mkv2mp4') { o.copyStreams = mkvFastCopy; o.crf = +$('mkv2mp4-quality').value; }
      if (activeTool === 'shrink') { o.targetDuration = +$('shrink-duration').value; }
      if (activeTool === 'loop') { o.autoDetect = loopAutoDetect; o.start = +$('loop-start').value; o.end = +$('loop-end').value; }
      if (activeTool === 'thumb') { o.imagePath = $('thumb-image').value; }
      if (activeTool === 'trim') { o.trimStart = +$('trim-start').value; o.trimEnd = +$('trim-end').value; o.accurate = trimAccurate; }
      if (activeTool === 'shorts') { o.mode = shortsMode; o.cropX = shortsCropX; }
      return o;
    }

    async function process() {
      if (!activeTool) return;
      const names = { compress:'Compressing', togif:'Creating GIF', mkv2mp4:'Converting to MP4', shrink:'Shrinking', loop:'Creating loop', thumb:'Setting thumbnail', trim:'Trimming', shorts:'Creating shorts' };
      const toolId = activeTool;
      $('main').classList.add('hide'); $('btns').classList.add('hide');
      $('loading').classList.add('on'); $('loading').querySelector('span').textContent = names[activeTool] + '...';
      try {
        const res = await postJson('/api/process', getOpts());

        if (res.success && res.output) {
          // Update the current working file to the output
          currentFilePath = res.output;
          info.fileName = res.output.split(/[\\/]/).pop();

          // Mark this tool as done
          $('t-' + toolId).classList.add('done');
          $('t-' + toolId).classList.remove('active');

          // If MKV→MP4 completed, other tools now work on the MP4
          if (toolId === 'mkv2mp4') {
            // Update video preview to the new MP4 file
            $('videoPreview').src = '/api/video?t=' + Date.now(); // Cache bust
          }

          updateFileDisplay();
        }

        $('loading').classList.remove('on');
        showResult(res.success, res.success ? res.output : res.error);
      } catch (e) {
        $('loading').classList.remove('on');
        showResult(false, e.message);
      }
    }

    function showResult(success, message) {
      $('done').classList.add('on', success ? 'ok' : 'err');
      $('done').classList.remove(success ? 'err' : 'ok');
      $('done').querySelector('h4').textContent = success ? 'Complete!' : 'Failed';
      $('output').textContent = message;
    }

    function continueEditing() {
      // Go back to main view to continue with other tools
      $('done').classList.remove('on', 'ok', 'err');
      $('main').classList.remove('hide');
      $('btns').classList.remove('hide');
      activeTool = null;
      $('processBtn').disabled = true;
      document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.opts').forEach(o => o.classList.remove('active'));
    }

    init();
  </script>
</body>
</html>
