<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>VidLet Loading</title>
<hta:application
  id="VidLetLoader"
  applicationName="VidLet"
  icon="tv.ico"
  border="none"
  borderStyle="normal"
  caption="no"
  innerBorder="no"
  maximizeButton="no"
  minimizeButton="no"
  showInTaskbar="yes"
  singleInstance="yes"
  scroll="no"
  contextMenu="no"
  selection="no"
  sysmenu="no"
/>
<style>
  *{margin:0;padding:0;cursor:default}
  html{height:100%;background:#000}
  body{height:100%;overflow:hidden;background:linear-gradient(180deg,#0a0a0c 0%,#111113 100%);font-family:Segoe UI,sans-serif;color:#e4e4e7;text-align:center;padding:24px;opacity:1;transition:opacity .3s ease-out;border:1px solid #333;border-radius:8px;box-sizing:border-box}
  body.fade-out{opacity:0}
  .logo{width:80px;height:80px;margin-bottom:8px;display:none}
  .anim{width:100px;height:100px;margin-bottom:4px}
  .title{font-size:28px;font-weight:700;color:#a855f7;margin-bottom:2px}
  .tagline{font-size:10px;color:#c084fc;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
  .desc{font-size:10px;color:#636366;margin-bottom:14px}
  .progress{font-size:14px;color:#a855f7;font-weight:600;margin-bottom:8px;min-height:18px}
  .progress-bar{width:60%;height:4px;background:#222;border-radius:2px;margin:0 auto;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#a855f7,#c084fc);width:0%;transition:width .2s}
  .website{font-size:11px;color:#a855f7;text-decoration:none;transition:color .2s;margin-top:16px;display:inline-block}
  .website:hover{color:#c084fc}
</style>
<script language="javascript">
  var w = 280, h = 330;
  window.resizeTo(w, h);
  window.moveTo((screen.availWidth - w) / 2, (screen.availHeight - h) / 2.5);

  // Pick a random animation
  var animations = ['rainbow-cat.gif'];
  var randomAnim = animations[Math.floor(Math.random() * animations.length)];

  // Drag support for borderless window
  var isDragging = false, dragX = 0, dragY = 0;
  window.onload = function() {
    document.getElementById('anim').src = 'animations/' + randomAnim;
    document.body.onmousedown = function(e) {
      isDragging = true;
      dragX = e.screenX - window.screenLeft;
      dragY = e.screenY - window.screenTop;
    };
    document.body.onmousemove = function(e) {
      if (isDragging) {
        window.moveTo(e.screenX - dragX, e.screenY - dragY);
      }
    };
    document.body.onmouseup = function() { isDragging = false; };
    document.body.onmouseleave = function() { isDragging = false; };
  };

  var fso = new ActiveXObject("Scripting.FileSystemObject");
  var shell = new ActiveXObject("WScript.Shell");
  var tempDir = shell.ExpandEnvironmentStrings("%TEMP%");
  var readyFile = tempDir + "\\vidlet-ready.tmp";
  var logFile = tempDir + "\\vidlet-loading.log";
  var pollTimer = null;
  var isClosing = false;
  var animProgress = 0;

  function log(msg) {
    try {
      var f = fso.OpenTextFile(logFile, 8, true);
      f.WriteLine(new Date().toISOString() + " | " + msg);
      f.Close();
    } catch(e) {}
  }

  // Clear previous log and start fresh
  try { fso.DeleteFile(logFile); } catch(e) {}
  log("=== HTA STARTED ===");
  log("tempDir: " + tempDir);
  log("readyFile: " + readyFile);
  log("HTA window positioned at center");

  function closeHTA() {
    log("closeHTA() - calling self.close()");
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    self.close();
  }

  function launchEdgeAndClose(url) {
    log("launchEdgeAndClose() called with URL: " + url);
    if (isClosing) {
      log("Already closing, ignoring");
      return;
    }
    isClosing = true;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;

    // Clean up ready file
    try { fso.DeleteFile(readyFile); } catch(e) {}
    log("Deleted ready file");

    // Start fade out
    log("Starting fade out animation");
    document.body.className = 'fade-out';

    // After fade completes, close HTA then open Edge
    setTimeout(function() {
      log("Fade complete");

      // Calculate centered position for Edge window
      var edgeW = 480, edgeH = 400;
      var x = Math.round((screen.availWidth - edgeW) / 2);
      var y = Math.round((screen.availHeight - edgeH) / 2);
      log("Edge position will be: " + x + "," + y);

      // Write VBS launcher that waits for HTA to close, then opens Edge
      var vbsPath = tempDir + "\\vidlet-launch.vbs";
      var vbsLogPath = tempDir + "\\vidlet-launch.log";
      try {
        var f = fso.CreateTextFile(vbsPath, true);
        // VBS logs its actions for debugging
        f.WriteLine('Set fso = CreateObject("Scripting.FileSystemObject")');
        f.WriteLine('Set logFile = fso.OpenTextFile("' + vbsLogPath + '", 8, True)');
        f.WriteLine('logFile.WriteLine Now & " | VBS started, waiting 500ms for HTA to close"');
        f.WriteLine('WScript.Sleep 500');
        f.WriteLine('logFile.WriteLine Now & " | Opening Edge at position ' + x + ',' + y + '"');
        f.WriteLine('CreateObject("WScript.Shell").Run "msedge --app=' + url + ' --window-position=' + x + ',' + y + '", 1, False');
        f.WriteLine('logFile.WriteLine Now & " | Edge launched"');
        f.WriteLine('logFile.Close');
        f.WriteLine('WScript.Sleep 200');
        f.WriteLine('fso.DeleteFile WScript.ScriptFullName');
        f.Close();
        log("Wrote VBS launcher: " + vbsPath);
      } catch(e) {
        log("ERROR writing VBS: " + e.message);
      }

      // Run VBS in background (hidden)
      log("Running VBS launcher");
      shell.Run('wscript "' + vbsPath + '"', 0, false);

      // Now close the HTA - VBS will wait and then open Edge
      log("Closing HTA now (VBS will open Edge after 500ms)");
      closeHTA();
    }, 350);
  }

  function animateProgress() {
    // Fake progress animation while waiting
    animProgress += 2;
    if (animProgress > 90) animProgress = 90;
    document.getElementById('progress-fill').style.width = animProgress + '%';
  }

  // Failsafe timeout (30 seconds)
  log("Setting up failsafe timeout (30s)");
  setTimeout(function() {
    if (!isClosing) {
      log("FAILSAFE TIMEOUT triggered - closing without Edge");
      closeHTA();
    }
  }, 30000);

  // Poll for ready signal
  log("Starting poll timer in 200ms");
  setTimeout(function() {
    log("Poll timer started - checking for ready file every 100ms");
    pollTimer = setInterval(function() {
      // Animate progress bar
      animateProgress();

      // Check for ready file
      if (fso.FileExists(readyFile)) {
        log("Ready file detected!");
        try {
          var f = fso.OpenTextFile(readyFile, 1);
          var url = f.ReadAll();
          f.Close();
          log("URL from ready file: " + url);
          if (url && url.length > 0) {
            launchEdgeAndClose(url);
          } else {
            log("ERROR: URL is empty");
          }
        } catch(e) {
          log("ERROR reading ready file: " + e.message);
        }
      }
    }, 100);
  }, 200);
</script>
</head>
<body>
  <img class="anim" id="anim" src="animations/rainbow-cat.gif">
  <img class="logo" src="tv.png">
  <div class="title">VidLet</div>
  <div class="tagline">Trim &bull; Compose &bull; Publish</div>
  <div class="desc">Lightweight video tools for content creators</div>
  <div class="progress" id="progress">Loading...</div>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:5%"></div></div>
  <a class="website" href="#" onclick="shell.Run('https://vidlet.app');return false">vidlet.app</a>
</body>
</html>
