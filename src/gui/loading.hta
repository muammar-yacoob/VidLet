<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>VidLet Loading</title>
<hta:application
  id="VidLetLoader"
  applicationName="VidLet"
  border="thin"
  borderStyle="normal"
  caption="yes"
  innerBorder="no"
  maximizeButton="no"
  minimizeButton="no"
  showInTaskbar="yes"
  singleInstance="yes"
  scroll="no"
  contextMenu="no"
  selection="no"
  sysmenu="no"
/>
<style>
  *{margin:0;padding:0}
  html{height:100%;background:#000}
  body{height:100%;overflow:hidden;background:linear-gradient(180deg,#0a0a0c 0%,#111113 100%);font-family:Segoe UI,sans-serif;color:#e4e4e7;text-align:center;padding:24px;opacity:1;transition:opacity .3s ease-out}
  body.fade-out{opacity:0}
  .logo{width:80px;height:80px;margin-bottom:8px}
  .title{font-size:28px;font-weight:700;color:#a855f7;margin-bottom:2px}
  .tagline{font-size:10px;color:#c084fc;font-weight:600;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
  .desc{font-size:10px;color:#636366;margin-bottom:14px}
  .progress{font-size:14px;color:#a855f7;font-weight:600;margin-bottom:8px;min-height:18px}
  .progress-bar{width:60%;height:4px;background:#222;border-radius:2px;margin:0 auto;overflow:hidden}
  .progress-fill{height:100%;background:linear-gradient(90deg,#a855f7,#c084fc);width:0%;transition:width .2s}
  .website{font-size:11px;color:#a855f7;text-decoration:none;transition:color .2s;margin-top:16px;display:inline-block}
  .website:hover{color:#c084fc}
</style>
<script language="javascript">
  var w = 280, h = 320;
  window.resizeTo(w, h);
  window.moveTo((screen.availWidth - w) / 2, (screen.availHeight - h) / 2.5);

  var fso = new ActiveXObject("Scripting.FileSystemObject");
  var shell = new ActiveXObject("WScript.Shell");
  var tempDir = shell.ExpandEnvironmentStrings("%TEMP%");
  var readyFile = tempDir + "\\vidlet-ready.tmp";
  var progressFile = tempDir + "\\vidlet-progress.tmp";
  var pollTimer = null;
  var isClosing = false;
  var mainOpened = false;
  var mainUrl = "";
  var cacheThreshold = 20; // Default threshold

  // Set icon dynamically using absolute path
  try {
    var scriptPath = unescape(document.location.pathname).replace(/\//g, "\\");
    if (scriptPath.charAt(0) === "\\") scriptPath = scriptPath.substring(1);
    var scriptDir = scriptPath.substring(0, scriptPath.lastIndexOf("\\"));
    var iconPath = scriptDir + "\\..\\icons\\tv.ico";
    VidLetLoader.icon = iconPath;
  } catch(e) {}

  function closeWindow() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    try { fso.DeleteFile(readyFile); } catch(e) {}
    try { fso.DeleteFile(progressFile); } catch(e) {}
    self.close();
  }

  function showMainAndClose() {
    if (isClosing) return;
    isClosing = true;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    // Restore the minimized Edge window using PowerShell
    try {
      var restoreCmd = 'powershell -WindowStyle Hidden -Command "$w = Get-Process msedge -ErrorAction SilentlyContinue | Where-Object {$_.MainWindowTitle -like \'*VidLet*\'}; if($w){[void][System.Reflection.Assembly]::LoadWithPartialName(\'Microsoft.VisualBasic\');[Microsoft.VisualBasic.Interaction]::AppActivate($w.Id)}"';
      shell.Run(restoreCmd, 0, false);
    } catch(e) {}
    // Fallback: simple AppActivate
    setTimeout(function() {
      try { shell.AppActivate('VidLet'); } catch(e) {}
    }, 100);
    try { fso.DeleteFile(readyFile); } catch(e) {}
    try { fso.DeleteFile(progressFile); } catch(e) {}
    document.body.className = 'fade-out';
    setTimeout(closeWindow, 300);
  }

  function openMainMinimized() {
    if (mainOpened) return;
    mainOpened = true;
    // Read URL and open Edge minimized
    try {
      var f = fso.OpenTextFile(readyFile, 1);
      mainUrl = f.ReadAll();
      f.Close();
      if (mainUrl && mainUrl.length > 0) {
        // Use PowerShell to start Edge minimized (more reliable)
        var cmd = 'powershell -WindowStyle Hidden -Command "Start-Process msedge -ArgumentList \'--app=' + mainUrl.replace(/'/g, "''") + '\' -WindowStyle Minimized"';
        shell.Run(cmd, 0, false);
      }
    } catch(e) {}
  }

  function checkProgress() {
    var pct = 0;
    try {
      if (fso.FileExists(progressFile)) {
        var f = fso.OpenTextFile(progressFile, 1);
        pct = parseInt(f.ReadAll(), 10);
        f.Close();
        if (!isNaN(pct)) {
          document.getElementById('progress').innerText = 'Caching ' + pct + '%';
          document.getElementById('progress-fill').style.width = pct + '%';
        }
      }
    } catch(e) {}
    return pct;
  }

  // Failsafe timeout (30 seconds)
  setTimeout(showMainAndClose, 30000);

  // Poll for ready signal and progress updates
  setTimeout(function() {
    pollTimer = setInterval(function() {
      // Check if server is ready and open main window minimized
      if (!mainOpened && fso.FileExists(readyFile)) {
        openMainMinimized();
      }
      // Check progress and show main window when threshold reached
      var pct = checkProgress();
      if (mainOpened && pct >= cacheThreshold) {
        showMainAndClose();
      }
    }, 100);
  }, 300);
</script>
</head>
<body>
  <img class="logo" src="../icons/tv.png">
  <div class="title">VidLet</div>
  <div class="tagline">Trim &bull; Compose &bull; Publish</div>
  <div class="desc">Lightweight video tools for content creators</div>
  <div class="progress" id="progress">Loading...</div>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:5%"></div></div>
  <a class="website" href="#" onclick="shell.Run('https://vidlet.app');return false">vidlet.app</a>
</body>
</html>
