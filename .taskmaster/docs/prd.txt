# VidLet npm Package Conversion PRD

## Overview
Convert VidLet from a Windows batch script toolkit to a modern TypeScript npm package (`@spark-apps/vidlet`) that runs on WSL while integrating with Windows shell context menus.

## Goals
1. Package as `@spark-apps/vidlet` on npm
2. Run all video processing in WSL using native ffmpeg
3. Windows registry calls WSL directly (no batch file wrappers)
4. TypeScript codebase with Biome for linting/formatting
5. Clean architecture with separation of concerns

## Architecture

### Package Structure
```
vidlet/
├── src/
│   ├── index.ts              # Main exports
│   ├── cli.ts                # CLI entry point (vidlet command)
│   ├── core/
│   │   ├── ffmpeg.ts         # FFmpeg command builder and executor
│   │   ├── config.ts         # Configuration management (JSON-based)
│   │   └── paths.ts          # Windows/WSL path conversion utilities
│   ├── tools/
│   │   ├── compress.ts       # Video compression (libx264)
│   │   ├── togif.ts          # MP4 to GIF with palette optimization
│   │   ├── loop.ts           # Seamless loop detection and creation
│   │   ├── mkv2mp4.ts        # MKV to MP4 conversion
│   │   ├── shrink.ts         # Video speed-up to target duration
│   │   └── thumb.ts          # Video thumbnail extraction
│   ├── detection/
│   │   └── loop-detector.ts  # Frame similarity detection (replaces Python)
│   └── registry/
│       ├── install.ts        # Windows registry installation
│       └── uninstall.ts      # Windows registry removal
├── package.json
├── tsconfig.json
├── biome.json
└── README.md
```

### CLI Commands
- `vidlet install` - Install Windows shell context menu entries
- `vidlet uninstall` - Remove Windows shell context menu entries
- `vidlet compress <file>` - Compress video
- `vidlet togif <file>` - Convert to GIF
- `vidlet loop <file>` - Create seamless loop
- `vidlet mkv2mp4 <file>` - Convert MKV to MP4
- `vidlet shrink <file>` - Shrink video to target duration
- `vidlet thumb <file>` - Set video thumbnail
- `vidlet config` - Manage configuration

### Registry Integration
Registry commands will call WSL directly:
```
wsl.exe -e vidlet compress "$(wslpath '%1')"
```

The path conversion happens via wslpath which converts Windows paths to WSL paths.

### Configuration
Migrate from INI to JSON config at `~/.config/vidlet/config.json`:
```json
{
  "compress": {
    "bitrate": 2500,
    "preset": "medium"
  },
  "togif": {
    "fps": 15,
    "width": 480,
    "dither": "sierra2_4a"
  },
  "loop": {
    "searchDuration": 5,
    "minLength": 1,
    "maxLength": 3,
    "threshold": 0.98,
    "crossfade": 0.5
  },
  "shrink": {
    "targetDuration": 59.5
  },
  "mkv2mp4": {
    "copyStreams": true,
    "crf": 23
  },
  "thumb": {
    "timestamp": "00:00:01"
  }
}
```

### FFmpeg Strategy
- Use WSL's native ffmpeg (installed via `apt install ffmpeg`)
- No bundled ffmpeg binary needed
- Spawn child processes using execa or node:child_process

### Loop Detection Migration
Replace Python OpenCV script with Node.js using:
- `sharp` for image processing (fast, no native deps)
- `pixelmatch` for frame comparison
- Extract frames via ffmpeg, compare in memory

## Technical Requirements

### Dependencies
- TypeScript 5.x
- execa - Process execution
- sharp - Image processing for loop detection
- commander - CLI framework
- chalk - Terminal colors (optional)
- zod - Config validation

### Dev Dependencies
- @biomejs/biome - Linting and formatting
- tsup - Build tool
- vitest - Testing

### Node.js Requirements
- Node.js 18+ (for native fetch and other modern APIs)
- WSL with ffmpeg installed

## Tasks

### Phase 1: Project Setup
1. Initialize npm package with package.json
2. Configure TypeScript (tsconfig.json)
3. Configure Biome (biome.json)
4. Set up build pipeline with tsup
5. Create CLI entry point structure

### Phase 2: Core Infrastructure
1. Implement path conversion utilities (Windows <-> WSL)
2. Create FFmpeg command builder and executor
3. Implement JSON configuration management
4. Create base tool class/interface

### Phase 3: Video Tools
1. Port compress tool to TypeScript
2. Port togif tool with palette generation
3. Port mkv2mp4 tool
4. Port shrink tool
5. Port thumb tool
6. Port loop tool with frame detection

### Phase 4: Registry Integration
1. Implement registry file generator
2. Create install command (generates .reg and imports via reg.exe)
3. Create uninstall command
4. Handle elevation requirements messaging

### Phase 5: Testing and Polish
1. Add Biome linting rules and fix issues
2. Write unit tests for path conversion
3. Write integration tests for tools
4. Add --help documentation for all commands
5. Final cleanup and documentation

## Success Criteria
- `npm install -g @spark-apps/vidlet` works
- `vidlet install` adds Windows context menu items
- Right-clicking video files shows VidLet options
- All 6 video tools work correctly via WSL
- Biome lint passes with no errors
- Clean TypeScript compilation
